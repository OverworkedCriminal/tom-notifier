#
# Dockerfile is meant to be build with the context set to the parent directory
#

FROM rust:1.81 as builder

WORKDIR /usr/src/tom-notifier-ws-delivery

COPY ./tom-notifier-ws-delivery ./
COPY ./shared ../shared

RUN apt-get update && apt-get install -y protobuf-compiler && cargo install --path .



FROM debian:bookworm-slim

ENV TOM_NOTIFIER_WS_DELIVERY_LOG_DIRECTORY="logs"
ENV TOM_NOTIFIER_WS_DELIVERY_LOG_FILENAME="tom-notifier-ws-delivery-log"
ENV TOM_NOTIFIER_WS_DELIVERY_BIND_ADDRESS="0.0.0.0:4001"
ENV TOM_NOTIFIER_WS_DELIVERY_DB_CONNECTION_STRING="mongodb://admin:admin@localhost:27017"
ENV TOM_NOTIFIER_WS_DELIVERY_DB_NAME="tom_notifier_ws_delivery"
ENV TOM_NOTIFIER_WS_DELIVERY_WEBSOCKET_TICKET_LIFESPAN="30"
ENV TOM_NOTIFIER_WS_DELIVERY_WEBSOCKET_PING_INTERVAL="30"
ENV TOM_NOTIFIER_WS_DELIVERY_WEBSOCKET_RETRY_MAX_COUNT="5"
ENV TOM_NOTIFIER_WS_DELIVERY_WEBSOCKET_RETRY_INTERVAL="10"
ENV TOM_NOTIFIER_WS_DELIVERY_WEBSOCKET_CONNECTION_BUFFER_SIZE="16"
ENV TOM_NOTIFIER_WS_DELIVERY_JWT_ALGORITHMS="HS256,HS512"
ENV TOM_NOTIFIER_WS_DELIVERY_JWT_KEY="secret"
ENV TOM_NOTIFIER_WS_DELIVERY_JWT_TEST_ENCODE_KEY=${TOM_NOTIFIER_WS_DELIVERY_JWT_KEY}
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_CONNECTION_STRING="amqp://admin:admin@localhost:5672"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_NOTIFICATIONS_EXCHANGE_NAME="tom_notifier_notifications"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_NOTIFICATIONS_QUEUE_NAME="tom_notifier_notifications"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_CONFIRMATIONS_EXCHANGE_NAME="tom_notifier_confirmations"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_RETRY_INTERVAL="10"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_DEDUPLICATION_NOTIFICATION_LIFESPAN="30"
ENV TOM_NOTIFIER_WS_DELIVERY_RABBITMQ_DEDUPLICATION_GARBAGE_COLLECTOR_INTERVAL="120"

RUN apt-get update && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/local/cargo/bin/tom-notifier-ws-delivery /usr/local/bin/tom-notifier-ws-delivery

CMD [ "tom-notifier-ws-delivery" ]